<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Demo 2 - Face ID</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <style>
        
    </style>
  </head>

  <body>
    <canvas id="canvas" height="480" width="720"></canvas>
    <video style="display: none;" id="video" autoplay="true"></video>
    <div>
      <button id="addNew">Add person</button>
      <button id="request">Request payment</button>
    </div>
    <div id="addNewContent">
      <label for="name">Name:</label><input id="name"/>
      <label for="email">Email:</label><input id="email"/>
      <button id="add">Add</button>
    </div>
    <div id="requestContent" style="display: none;">
      <label for="to">To:</label><input id="to"/>
      <label for="amount">Amount:</label><input id="amount"/>
      <button id="requestPayment">Request payment</button>
    </div>
    <script src="face-api.js" type="text/javascript"></script>
    <script>
      var canvas = document.getElementById("canvas");
      var context = canvas.getContext("2d");
      var video = document.getElementById("video");
      var errBack = function(error) {
        console.log("Video capture error: ", error.code); 
      };
      var raf = 0;
      var person = [];
      var requestPeople = [];
      const faces = JSON.parse(localStorage.getItem('faces') || '{}');

      document.getElementById('addNew').addEventListener('click', switchTabs);
      document.getElementById('request').addEventListener('click', switchTabs);

      function switchTabs(e) {
        if (e.currentTarget.id === 'addNew') {
          document.getElementById('addNewContent').style.display = 'block';
          document.getElementById('requestContent').style.display = 'none';
        } else {
          document.getElementById('addNewContent').style.display = 'none';
          document.getElementById('requestContent').style.display = 'block';
        };
      }

      document.getElementById('add').addEventListener('click', addPerson);
      document.getElementById('requestPayment').addEventListener('click', requestPayment);

      async function addPerson() {
        const singleResult = await faceapi.detectSingleFace(canvas).withFaceLandmarks().withFaceDescriptor();
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        if (faces[name]) {
          alert(`${name} already added`);
          return;
        }
        faces[name] = new faceapi.LabeledFaceDescriptors(name, [singleResult.descriptor]);
        localStorage.setItem('faces', JSON.stringify(faces));
      }



      navigator.mediaDevices.getUserMedia({ audio: false, video: true, video: { width: { min: 720 }, height: { min: 480 }}}).then((stream) => {
        video.srcObject = stream;
        requestAnimationFrame(renderFrame);
      });

      function calculateSize(srcSize, dstSize) {
        var srcRatio = srcSize.width / srcSize.height;
        var dstRatio = dstSize.width / dstSize.height;
        if (dstRatio > srcRatio) {
          return {
            width:  dstSize.height * srcRatio,
            height: dstSize.height
          };
        } else {
          return {
            width:  dstSize.width,
            height: dstSize.width / srcRatio
          };
        }
      }

      async function renderFrame() {
        // re-register callback
        //requestAnimationFrame(renderFrame);
        if (raf <= 10) setTimeout(renderFrame, 1000);
        // set internal canvas size to match HTML element size
        canvas.width = canvas.scrollWidth;
        canvas.height = canvas.scrollHeight;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          // scale and horizontally center the camera image
          var videoSize = { width: video.videoWidth, height: video.videoHeight };
          var canvasSize = { width: canvas.width, height: canvas.height };
          var renderSize = calculateSize(videoSize, canvasSize);
          var xOffset = (canvasSize.width - renderSize.width) / 2;
          context.drawImage(video, xOffset, 0, renderSize.width, renderSize.height);
          await faceID();
        }
      }

      async function init() {
        await faceapi.loadSsdMobilenetv1Model('/Demo2/');
        await faceapi.loadFaceLandmarkModel('/Demo2/');
        await faceapi.loadFaceRecognitionModel('/Demo2/');
      }

      const friendAmount = {
        gavin: 0,
        mila: -15
      };

      async function faceID() {
        const faceDescriptors = [];
        if (Object.keys(faces).length) {
          Object.keys(faces).forEach((face) => {
            faceDescriptors.push(new faceapi.LabeledFaceDescriptors(face, [new Float32Array(faces[face].descriptors[0])]));
          });
        }
        
        let faceLandmarks = await faceapi.detectAllFaces(canvas).withFaceLandmarks().withFaceDescriptors();
        faceapi.draw.drawFaceLandmarks(canvas, faceLandmarks);
        if (faceDescriptors.length) {
          const faceMatcher = new faceapi.FaceMatcher(faceDescriptors);
          faceLandmarks.forEach((fd) => {
            const bestMatch = faceMatcher.findBestMatch(fd.descriptor);
            const opts = {
              label: bestMatch.label,
              lineWidth: 2
            };
            if (friendAmount[bestMatch.label.toLowerCase()] < 0) {
              opts.boxColor = 'rgba(255, 0, 0, 0.7)'; 
              opts.label += ` - Owes $${friendAmount[bestMatch.label.toLowerCase()]}`;
            }
            if (bestMatch.distance <= 0.5) {
              const drawBox = new faceapi.draw.DrawBox(fd.alignedRect.box, opts);
              drawBox.draw(canvas);
              if (document.getElementById('requestContent').style.display === 'block') {
                if (!requestPeople.includes(bestMatch.label)) requestPeople.push(bestMatch.label);
                document.getElementById('to').value = requestPeople.join(', ');
              }
            }
            
            //console.log(bestMatch.toString())
          });
        }
      }

      init();
    </script>
  </body>
</html>
